<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
    "http://www.w3.org/TR/html4/strict.dtd">
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="initial-scale=1, width=device-width, maximum-scale=1, user-scalable=no" />
  <title>HTML Model</title>
  <link rel="stylesheet" href="./css/test.css"></head>
  <style type="text/css"></style>
  <script type="text/javascript" src="./js/common.js"></script>
  <script type="text/javascript" src="./js/fe.js"></script>
  <script type="text/javascript" src="./js/xhr-2.js"></script>
  <!-- <script type="text/javascript" src="/assets/libs/axios/axios.20190729.min.js"></script> -->
  <script>
    function handleFileChange(evt) {
      // can not reach
      console.log(evt);
      console.log(evt.target.files);
    }

    function showUploadFile() {
      const container = document.querySelector('.container');
      const toPostFiles = container.querySelector('.for-post-files .to-post-files');
      const fileSelected = container.querySelector('.for-post-files input[name="fileList"]');
      toPostFiles.addEventListener('click', evt => {
        console.log(fileSelected.name);
        console.log(fileSelected.files);
        // console.log(fileSelected.files.length);
        if (fileSelected.files.length > 0) {
          new PostWays().postFile(fileSelected.files[0]);
          
          // var formData = new FormData();
          // formData.append(fileSelected.name, fileSelected.files);
          // new PostWays().postFormData(formData);
        }
      })
    }
  
  // BlobBuilder is instead by Blob
  function getBlob() {
    const dataList = [];
    dataList.push('This blob contains this text and 10 big-endian 32-bit signed ints.');
    dataList.push('\O');
    var ab = new ArrayBuffer(4 * 100);
    var dv = new DataView(ab);
    for (let i = 0; i < 100; i++) {
      dv.setInt32(i * 4, i);
    }
    dataList.push(ab);
    return new Blob(dataList);
  }

  const URL_LIST = {
    get_js: {
      path: '/api/test',
      method: 'get',
      query: {
        extension: 'js'
      }
    },
    get_xml: {
      path: '/api/test',
      method: 'get',
      query: {
        extension: 'xml'
      }
    },
    get_png: {
      path: '/api/test',
      method: 'get',
      query: {
        extension: 'png'
      }
    },
    get_js_slow: {
      path: '/api/test',
      method: 'get',
      query: {
        extension: 'js',
        slow: true
      },
      onDownloadProgress(evt) {
        console.log(evt);
      }
    },
    get_js_wait: {
      path: '/api/test',
      method: 'get',
      query: {
        extension: 'js',
        wait: 10
      },
    },
    get_js_timeout: {
      path: '/api/test',
      method: 'get',
      timeout: 5 * 1000,
      query: {
        extension: 'js',
        wait: 10
      },
    },
    download_by_blob: {
      path: '/api/test',
      method: 'get',
      responseType: 'blob',
      query: {
        extension: 'js'
      }
    },
    download_by_tag_a: {
      path: '/api/test',
      method: 'get',
      responseType: 'blob',
      query: {
        extension: 'js'
      }
    },
    post_json: {
      path: '/api/test/echo',
      method: 'post',
      headers: {
        'content-type': 'application/json'
      },
      data: {
        a: 1, b: 2
      }
    },
    post_form_urlencoded: {
      path: '/api/test/echo',
      method: 'post',
      headers: {
        'content-type': 'application/x-www-form-urlencoded'
      },
      data: utils.convertJSONDataByContentType({
        a: 1, b: 2
      }, 'application/x-www-form-urlencoded')
    },
    post_form: {
      path: '/api/test/echo',
      method: 'post',
      headers: {
        'content-type': 'multipart/form-data'
      },
      data: utils.convertJSONDataByContentType({
        a: 1, b: 2
      }, 'multipart/form-data')
    }
  }
  
  window.addEventListener('load', function() {

    async function handleAction(action, data) {
      if (URL_LIST.hasOwnProperty(action)) {
        const config = URL_LIST[action];

        if (config.query && config.query.wait) {
          var count = config.query.wait;
          const intervalTag = setInterval(() => {
            console.log(count--);
            if (count <= 0) {
              clearInterval(intervalTag);
            }
          }, 1000);
        }

        // download_by_tag_a
        if (action === 'download_by_tag_a') {
          utils.downloadByTagA(config.path, 'test.js');
          return;
        }
        try {
          const response = await xhrAdapter(config);

          // download_by_blob
          if (action === 'download_by_blob') {
            utils.downloadByBlob(response.data);
          }
          console.log(response);
        } catch (err) {
          console.log(err);
        }
        return;
      }
      if (!action) {
        return;
      }
      const actionToUrl = {
        'download-by-blob': '/api/test/get/common?type=png&feature=slow&fileName=gnu-icon-small.png',
        'download-by-tag-a': '/api/test/get/common?type=png&feature=slow&fileName=gnu-icon-small.png'
      }
      // console.log({action, url});
      var resData = null;
      if (action.startsWith('/api/test/get/common')) {
        xhrAction.getCommon(action);
      } else if (action.startsWith('/api/test/echo')) {
        xhrAction.postCommon(action, data);
      } else if (action.startsWith('/api/test/post/common')) {
        xhrAction.postCommon(action, data);
      } else {
        switch (action) {
          case 'request/abort':
            xhrAction.requestMethods(url, 'abort');
            break;
          case 'readystatechange':
            xhrAction.readystatechange(url);
            break;
          case 'post-by-form':
            // var form = document.querySelector(target.dataset.for);
            var form = document.querySelector('.form .form-item.form-sheet');
            // form.style.display = 'block';
            if (!form.style.display) {
              form.style.display = 'block';
            } else {
              switch (form.style.display) {
                case 'block':
                  form.style.display = 'none';
                  break;
                case 'none':
                  form.style.display = 'block';
                  break;
              }
            }
            if (form.style.display == 'block') {
              form.querySelector('.the-form').onsubmit = (evt) => {
                const target = evt.target;
                // new FormData(target)
                xhrAction.postCommon('/api/test/echo?content-type=multipart/form-data', new FormData(target));
                evt.preventDefault();
              }
            }
            break;
          case 'post-blob':
            xhrAction.post(getBlob());
            break;
          case 'server-error':
            // resData = await axiosHelper.requestData({
            //   method: 'get',
            //   path: url
            // });
            // console.log(resData);
            break;
        }
      }
    }
    
    const container = document.querySelector('.container');
    container.addEventListener('click', async evt => {
      var target = evt.target;
      while (target && target !== container && target.tagName != 'BUTTON') {
        target = target.parentNode;
      }
      const action = target.dataset.action;
      handleAction(action);
    });

    const sectionFile = container.querySelector('.form .form-item.upload input.upload-more-files');
    sectionFile.addEventListener('change', evt => {
      // 不论是否有multiple标签，evt.target.files都是类数组
      // console.log(evt);
      // console.log(evt.target.files);
      // console.log(typeof evt.target.files); // object
      // console.log(evt.target.files instanceof FileList); // true
      handleAction('/api/test/post/common?content-type=multipart/form-data', {
        files: evt.target.files
      })
    });
  });
  window.addEventListener('err', err => {
    console.log(err);
  })
  </script>
  <style>
  .for-post-files {
    padding: 10px;
  }
  .for-post-files input[name="fileList"] {
    font-size: 16px;
    padding: 3px 6px;
    width: 360px;
  }
  </style>
</head>

<body>
  <div class="container">
    <div class="form">
      <div class="form-item">
        <div class="form-item-label">XHR Status:</div>
        <div class="form-item-content">
          <button data-action="/api/test/get/common?type=js&feature=slow" data-url="{a: 1, b: 2, params: {c: 2}, method: 'get'}">REQUEST/ABORT</button>
          <!-- <button data-action="readystatechange" data-url="/api/test/get/common?type=xml&feature=slow">REQUEST/XML</button> -->
          <!-- <button data-action="readystatechange" data-url="/api/test/get/common?type=png&feature=slow">REQUEST/BIN</button> -->
        </div>
      </div>
      <div class="form-item">
        <div class="form-item-label">get:</div>
        <div class="form-item-content">
          <button data-action="get_js">get_js</button>
          <button data-action="get_xml">get_xml</button>
          <button data-action="get_png">get_png</button>
        </div>
      </div>
      <div class="form-item">
        <div class="form-item-label">feature:</div>
        <div class="form-item-content">
          <button data-action="get_js_slow">get_js_slow</button>
          <button data-action="get_js_wait">get_js_wait</button>
          <button data-action="get_js_timeout">get_js_timeout</button>
        </div>
      </div>
      <div class="form-item">
        <div class="form-item-label">download:</div>
        <div class="form-item-content">
          <button data-action="download_by_blob">download_by_blob</button>
          <button data-action="download_by_tag_a">download_by_tag_a</button>
        </div>
      </div>
      <div class="form-item">
        <div class="form-item-label">post:</div>
        <div class="form-item-content">
          <button data-action="post_json">post_json</button>
          <button data-action="post_form_urlencoded">post_form_urlencoded</button>
          <button data-action="post_form">post_form</button>
          <button data-action="post-by-form"><span>POST-FORM</span></button>
        </div>
      </div>
      <div class="form-item form-sheet" style="display: none">
        <div class="form-item-label"></div>
        <div class="form-item-content">
          <div class="title">Research From</div>
          <!-- default enctype is application/x-www-form-urlencoded -->
          <!-- enctype="multipart/form-data"  -->
          <!-- method="post" action="/api/post-data" -->
          <form class="the-form" name="the-form" method="post" action="/api/test/post/normal">
            <div class="form-item">
              <div class="label">name</div>
              <div class="content">
                <input type="text" name="name">
              </div>
            </div>
            <div class="form-item">
              <div class="label">email address</div>
              <div class="content">
                <input type="text" name="email" value="default-email">
              </div>
            </div>
            <div class="form-item">
              <div class="label">apartment farming skills</div>
              <div class="content">
                <label>
                  <input name="skill" type="radio" value="novice" checked>Novice
                </label>
                <label>
                  <input name="skill" type="radio" value="intermediate">Intermediate
                </label>
                <label>
                  <input name="skill" type="radio" value="advanced">Advanced
                </label>
              </div>
            </div>
            <div class="form-item">
              <div class="label">Select your favorite</div>
              <div class="content">
                <label>
                  <input name="likeMovie" type="checkbox" value="movie">Movie
                </label>
                <label>
                  <input name="likeMusic" type="checkbox" value="music">Music
                </label>
                <label>
                  <input name="likeReading" type="checkbox" value="reading">Reading
                </label>
              </div>
            </div>
            <div class="form-item">
              <div class="label">Where did you hear about us? </div>
              <div class="content">
                <!-- multiple for multiple select -->
                <select name="refer">
                  <option value="no">No</option>
                  <option value="friend">Friend</option>
                  <option value="herban-jungle" selected>Herban Jungle</option>
                  <option value="compost-today">Compost Today</option>
                  <option value="vanity-fair">Vanity Fair</option>
                </select>
              </div>
            </div>
            <div class="form-item">
              <div class="label">Upload file</div>
              <div class="content">
                <!-- file can be filtered by accept=".png, .jpg, .jpeg" -->
                <input name="uploadFiles" multiple type="file"></input>
              </div>
            </div>
            <div class="form-item">
              <div class="label">Any additional comments? </div>
              <div class="content">
                <textarea name="comments" cols="35" rows="4"></textarea>
              </div>
            </div>
            <div class="form-item footer">
              <div class="item">
                <input class="el-button" type="submit" value="Subscribe">
              </div>
              <div class="item">
                <input class="el-button" type="reset" value="Reset">
              </div>
            </div>
          </form>
        </div>
      </div>
      <div class="form-item upload">
        <div class="form-item-label">UPLOAD:</div>
        <div class="form-item-content">
          <label style="position: relative; display: inline-block;">
            <span class="button">上传多个文件</span>
            <input class="button upload-more-files" type="file" name="fileList" title="上传文件" style="width: 0px; height: 0px; position: absolute; left: -9999px" onchange="handleFileChange" multiple>
          </label>
          <button data-action="post-blob">POST-BLOB</button>
        </div>
      </div>
      <div class="form-item">
        <div class="form-item-label"></div>
        <div class="form-item-content">
          <div class="section server">
            <button data-action="server-error" data-url="/api/test/error">SERVER-ERROR</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</body>

</html>
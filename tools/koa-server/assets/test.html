<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN"
    "http://www.w3.org/TR/html4/strict.dtd">
<html>

<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="initial-scale=1, width=device-width, maximum-scale=1, user-scalable=no" />
  <title>HTML Model</title>
  <link rel="stylesheet" href="./css/test.css"></head>
  <style type="text/css"></style>
  <script type="text/javascript" src="./js/common.js"></script>
  <script type="text/javascript" src="./js/fe.js"></script>
  <script type="text/javascript" src="./js/xhr-2.js"></script>
  <script>
  const URL_LIST = {
    get_js: {
      path: '/api/test',
      method: 'get',
      query: {
        extension: 'js'
      }
    },
    get_xml: {
      path: '/api/test',
      method: 'get',
      query: {
        extension: 'xml'
      }
    },
    get_png: {
      path: '/api/test',
      method: 'get',
      query: {
        extension: 'png'
      }
    },
    get_js_slow: {
      path: '/api/test',
      method: 'get',
      query: {
        extension: 'js',
        slow: true
      },
      onDownloadProgress(evt) {
        console.log(evt);
      }
    },
    get_js_wait: {
      path: '/api/test',
      method: 'get',
      query: {
        extension: 'js',
        wait: 10
      },
    },
    get_js_timeout: {
      path: '/api/test',
      method: 'get',
      timeout: 5 * 1000,
      query: {
        extension: 'js',
        wait: 10
      },
    },
    download_by_blob: {
      path: '/api/test',
      method: 'get',
      responseType: 'blob',
      query: {
        extension: 'js'
      }
    },
    download_by_tag_a: {
      path: '/api/test',
      method: 'get',
      responseType: 'blob',
      query: {
        extension: 'js'
      }
    },
    post_json: {
      path: '/api/test/echo',
      method: 'post',
      headers: {
        'content-type': 'application/json'
      },
      data: {
        a: 1, b: 2
      }
    },
    post_form_urlencoded: {
      path: '/api/test/echo',
      method: 'post',
      headers: {
        'content-type': 'application/x-www-form-urlencoded'
      },
      data: utils.convertJSONDataByContentType({
        a: 1, b: 2
      }, 'application/x-www-form-urlencoded')
    },
    post_form: {
      path: '/api/test/echo',
      method: 'post',
      headers: {
        'content-type': 'multipart/form-data'
      },
      data: utils.convertJSONDataByContentType({
        a: 1, b: 2
      }, 'multipart/form-data')
    },
    post_blob: {
      path: '/api/test/echo',
      method: 'post',
      headers: {
        'content-type': 'multipart/form-data'
      },
      data: utils.convertJSONDataByContentType({
        a: 1, b: 2,
        blob: new Blob(['This blob contains this text and 10 big-endian 32-bit signed ints.\n', 'second line'])
      }, 'multipart/form-data')
    },
    upload_blob: {
      path: '/api/test/upload',
      method: 'post',
      headers: {
        'content-type': 'multipart/form-data'
      },
      data: utils.convertJSONDataByContentType({
        a: 1, b: 2,
        blob: new Blob(['This blob contains this text and 10 big-endian 32-bit signed ints.\n', 'second line'])
      }, 'multipart/form-data')
    },
    upload_by_form: {
      path: '/api/test/upload',
      method: 'post',
      headers: {
        'content-type': 'multipart/form-data'
      },
      onUploadProgress(evt) {
        console.log(`upload: ${evt.loaded} / ${evt.total}`);
      },
      data: new FormData()
    }
  }

  async function onEvent(action, evt) {
    const uploadFileList = (fileList) => {
        fileList = [].slice.call(fileList);
        console.log(fileList);
        const formData = new FormData();
        fileList.forEach(file => {
          formData.append(file.name, file);
        })
        URL_LIST['upload_by_form'].data = formData;
        handleAction('upload_by_form');
        // console.log(Array.isArray(fileList)); // false
        // console.log(await utils.readBlobAsText(fileList[0])); // read content of file
        // console.log(typeof fileList); // object
        // console.log(fileList instanceof FileList); // true

    }
    const target = evt.target;
    switch (action) {
      case 'native_upload_files':
        uploadFileList(target.files);
        break;
      case 'toggle_native_submit_form':
      case 'toggle_native_drag_drop':
        const nodeMap = {
          toggle_native_submit_form: document.querySelector('.container .native_area .native_submit_form'),
          toggle_native_drag_drop: document.querySelector('.container .native_area .native_drag_drop')
        }
        const targetNode =nodeMap[action];
        Object.keys(nodeMap).filter(it => it != action).forEach(it => nodeMap[it].style.display = 'none');
        switch (targetNode.style.display) {
          case 'block':
            targetNode.style.display = 'none';
            break;
          case 'none':
            targetNode.style.display = 'block';
            break;
        }
        break;
      case 'native_submit_form':
        URL_LIST['upload_by_form'].data = new FormData(target);
        handleAction('upload_by_form')
        evt.preventDefault();
        break;
      case 'native_drag_enter':
        evt.stopPropagation();
        evt.preventDefault();
        console.log(`native_drag_enter`);
        break;
      case 'native_drag_over':
        evt.stopPropagation();
        evt.preventDefault();
        console.log(`native_drag_over`);
        break;
      case 'native_drop':
        evt.stopPropagation();
        evt.preventDefault();
        console.log(`native_drop`);
        uploadFileList(evt.dataTransfer.files);
        break;
    }
  }

  async function handleAction(action) {
    if (!URL_LIST.hasOwnProperty(action)) {
      throw new Error(`${action} not exist`);
    }
    const config = URL_LIST[action];

    if (config.query && config.query.wait) {
      var count = config.query.wait;
      const intervalTag = setInterval(() => {
        console.log(count--);
        if (count <= 0) {
          clearInterval(intervalTag);
        }
      }, 1000);
    }

    // download_by_tag_a
    if (action === 'download_by_tag_a') {
      utils.downloadByTagA(config.path, 'test.js');
      return;
    }
    try {
      const response = await xhrAdapter(config);

      // download_by_blob
      if (action === 'download_by_blob') {
        utils.downloadByBlob(response.data);
      }
      console.log(response);
    } catch (err) {
      console.log(err);
    }
  }

  window.addEventListener('load', function() {
    const container = document.querySelector('.container');
    // NOTICE: click event of Node with tagName 'button' will be listened here.
    container.addEventListener('click', async evt => {
      var target = evt.target;
      while (target && target !== container && target.tagName != 'BUTTON') {
        target = target.parentNode;
      }
      if (!target || target == container) {
        return;
      }
      const action = target.dataset.action;
      handleAction(action);
    });

  });
  window.addEventListener('err', err => {
    console.log(err);
  })
  </script>
  <style>
  .for-post-files {
    padding: 10px;
  }
  .for-post-files input[name="fileList"] {
    font-size: 16px;
    padding: 3px 6px;
    width: 360px;
  }
  </style>
</head>

<body>
  <div class="container">
    <div class="form">
      <div class="form-item">
        <div class="form-item-label">XHR Status:</div>
        <div class="form-item-content">
          <button data-action="/api/test/get/common?type=js&feature=slow" data-url="{a: 1, b: 2, params: {c: 2}, method: 'get'}">REQUEST/ABORT</button>
          <!-- <button data-action="readystatechange" data-url="/api/test/get/common?type=xml&feature=slow">REQUEST/XML</button> -->
          <!-- <button data-action="readystatechange" data-url="/api/test/get/common?type=png&feature=slow">REQUEST/BIN</button> -->
        </div>
      </div>
      <div class="form-item">
        <div class="form-item-label">get:</div>
        <div class="form-item-content">
          <button data-action="get_js">get_js</button>
          <button data-action="get_xml">get_xml</button>
          <button data-action="get_png">get_png</button>
        </div>
      </div>
      <div class="form-item">
        <div class="form-item-label">feature:</div>
        <div class="form-item-content">
          <button data-action="get_js_slow">get_js_slow</button>
          <button data-action="get_js_wait">get_js_wait</button>
          <button data-action="get_js_timeout">get_js_timeout</button>
        </div>
      </div>
      <div class="form-item">
        <div class="form-item-label">download:</div>
        <div class="form-item-content">
          <button data-action="download_by_blob">download_by_blob</button>
          <button data-action="download_by_tag_a">download_by_tag_a</button>
        </div>
      </div>
      <div class="form-item">
        <div class="form-item-label">post:</div>
        <div class="form-item-content">
          <button data-action="post_json">post_json</button>
          <button data-action="post_form_urlencoded">post_form_urlencoded</button>
          <button data-action="post_form">post_form</button>
          <button data-action="post_blob">post_blob</button>
        </div>
      </div>
      <div class="form-item upload">
        <div class="form-item-label">upload:</div>
        <div class="form-item-content">
          <button data-action="upload_blob">upload_blob</button>
        </div>
      </div>
<!--       <div class="form-item" style="display: none">
        <div class="form-item-label"></div>
        <div class="form-item-content">
          <div class="section server">
            <button data-action="server-error" data-url="/api/test/error">SERVER-ERROR</button>
          </div>
        </div>
      </div> -->
      <div class="form-item native">
        <div class="form-item-label">native:</div>
        <div class="form-item-content">
          <label class="button">
            native_upload_one_file
            <input class="visually-hidden" type="file" name="fileList" onchange="onEvent('native_upload_files', ...arguments)">
          </label>
          <label class="button">
            native_upload_multiple_files
            <input multiple class="visually-hidden" type="file" name="fileList" onchange="onEvent('native_upload_files', ...arguments)">
          </label>
          <div class="button" data-action="native_submit_form" onclick="onEvent('toggle_native_submit_form', ...arguments)">native_submit_form</div>
          <div class="button" data-action="native_drag_drop" onclick="onEvent('toggle_native_drag_drop', ...arguments)">toggle_native_drag_drop</div>
        </div>
      </div>
      <!-- native_submit_form -->
      <div class="form-item native_area">
        <div class="form-item-label"></div>
        <div class="form-item-content">
          <div class="native_submit_form" style="display: none">
            <div class="title">Research From</div>
            <!-- default enctype is application/x-www-form-urlencoded -->
            <!-- enctype="multipart/form-data"  -->
            <!-- method="post" action="/api/post-data" -->
            <!-- method="post" action="/api/test/upload" -->
            <form class="the-form" name="the-form" onsubmit="onEvent('native_submit_form', ...arguments)">
              <div class="form-item">
                <div class="label">name</div>
                <div class="content">
                  <input type="text" name="name">
                </div>
              </div>
              <div class="form-item">
                <div class="label">email address</div>
                <div class="content">
                  <input type="text" name="email" value="default-email">
                </div>
              </div>
              <div class="form-item">
                <div class="label">apartment farming skills</div>
                <div class="content">
                  <label>
                    <input name="skill" type="radio" value="novice" checked>Novice
                  </label>
                  <label>
                    <input name="skill" type="radio" value="intermediate">Intermediate
                  </label>
                  <label>
                    <input name="skill" type="radio" value="advanced">Advanced
                  </label>
                </div>
              </div>
              <div class="form-item">
                <div class="label">Select your favorite</div>
                <div class="content">
                  <label>
                    <input name="likeMovie" type="checkbox" value="movie">Movie
                  </label>
                  <label>
                    <input name="likeMusic" type="checkbox" value="music">Music
                  </label>
                  <label>
                    <input name="likeReading" type="checkbox" value="reading">Reading
                  </label>
                </div>
              </div>
              <div class="form-item">
                <div class="label">Where did you hear about us? </div>
                <div class="content">
                  <!-- multiple for multiple select -->
                  <select name="refer">
                    <option value="no">No</option>
                    <option value="friend">Friend</option>
                    <option value="herban-jungle" selected>Herban Jungle</option>
                    <option value="compost-today">Compost Today</option>
                    <option value="vanity-fair">Vanity Fair</option>
                  </select>
                </div>
              </div>
              <div class="form-item">
                <div class="label">Upload file</div>
                <div class="content">
                  <!-- file can be filtered by accept=".png, .jpg, .jpeg" -->
                  <input name="uploadFiles" multiple type="file"></input>
                </div>
              </div>
              <div class="form-item">
                <div class="label">Any additional comments? </div>
                <div class="content">
                  <textarea name="comments" cols="35" rows="4"></textarea>
                </div>
              </div>
              <div class="form-item footer">
                <div class="item">
                  <input class="el-button" type="submit" value="Subscribe">
                </div>
                <div class="item">
                  <input class="el-button" type="reset" value="Reset">
                </div>
              </div>
            </form>
          </div>
          <div class="native_drag_drop"
            ondrop="onEvent('native_drop', ...arguments); return false;"
            ondragenter="onEvent('native_drag_enter', ...arguments)"
            ondragover="onEvent('native_drag_over', ...arguments)"
            style="display: none">
          </div>
        </div>
      </div>
    </div>
  </div>
</body>

</html>